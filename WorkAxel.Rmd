---
  title: "Projet Tennis"
  output: html_notebook
---

Library 
```{r}
#install.packages("data.table")
library(data.table)
#install.packages("stringr")
library(stringr)
#install.packages("sqldf")
library(sqldf)
#install.packages("knitr")
library(knitr)
#install.packages("anytime")
library(anytime)
```

Import et premier retraitement sur le nom des variables
```{r}
Tennis_hist<-fread(file='Data/atp_matches.csv', header = T)
#On garde uniquement les lignes où on dispose des informations détaillées de match
Tennis_table=Tennis_hist[!is.na(minutes)]
head(Tennis_table)

atp_players<- fread(file ='Data/atp_players.csv' ,header = F)
colnames(atp_players)=c("Player_Id","Prenom","Nom","Main_Forte","DateNaissance","Nationalite")

Rank<- fread(file ='Data/rankings.csv' , header = F)
colnames(Rank)<-c("DateRanking","Numero","Player_Id","Points")
```


Varibale a rajouter/creer pour les statistiques faire sous 4 formes : générale,selon le head to head, selon le terrain, sur la saison
Fatigue du joueur -> fonction du nombre de matchs fait ces derniers jours et du nombre de jeux disputés ces derniers temps
Caracteristiques des joueurs Axel
Endurant ou pas (exemple s il a tendance a gagné ces matchs en 5 set ou 3 pour les filles)
Nombre de jeu par match, en cas de Tie break rajouter un jeu suppl?mentaire -> Fatigue
Reviens d'un abandon Axel -> Blessure : binaire = 1 si reviens d'un abandon

Transformation de la table tennis : Valeurs -> pourcentages
```{r}
#Creation de Tennis_table_work
Tennis_table_work=Tennis_table[,.(tourney_id,tourney_name,surface,tourney_date=anydate(tourney_date),tourney_level,match_num,round,round_num=data.table(V1=c('F','SF','QF','R16','R32','R64','R128','RR','BR'),V2=1:9)$V2[match(round,data.table(V1=c('F','SF','QF','R16','R32','R64','R128','RR','BR'),V2=1:9)$V1)],
w_id=winner_id,w_name=winner_name,w_age=winner_age,w_ht=winner_ht,w_rank=winner_rank,w_rank_points=winner_rank_points,w_hand=ifelse(winner_hand=='R',1,0) ,w_seed=winner_seed
,w_ace=w_ace/w_1stIn,w_df=w_df/w_svpt,w_1stIn=w_1stIn/w_svpt,w_1stWon=w_1stWon/w_1stIn,w_2ndWon=w_2ndWon/(w_svpt-w_1stIn),w_bpSaved=w_bpSaved/w_bpFaced,w_bpMean=l_bpFaced/l_SvGms,w_bpConverted=(l_bpFaced-l_bpSaved)/(l_bpFaced),w_svptWon=(w_1stWon+w_2ndWon)/w_svpt,w_returnPtWon=(l_svpt-l_1stWon-l_2ndWon)/l_svpt,w_1stReturnWon=(l_1stIn-l_1stWon)/l_1stIn,w_2ndReturnWon=((l_svpt-l_1stIn)-l_2ndWon)/(l_svpt-l_1stIn)
,l_id=loser_id,l_name=loser_name,l_age=loser_age,l_ht=loser_ht,l_rank=loser_rank,l_rank_points=loser_rank_points,l_hand=loser_hand,l_seed=loser_seed
,l_ace=l_ace/l_1stIn,l_df=l_df/l_svpt,l_1stIn=l_1stIn/l_svpt,l_1stWon=l_1stWon/l_1stIn,l_2ndWon=l_2ndWon/(l_svpt-l_1stIn),l_bpSaved=l_bpSaved/l_bpFaced,l_bpMean=w_bpFaced/w_SvGms,l_bpConverted=(w_bpFaced-w_bpSaved)/(w_bpFaced),l_svptWon=(l_1stWon+l_2ndWon)/l_svpt,l_returnPtWon=(w_svpt-w_1stWon-w_2ndWon)/w_svpt,l_1stReturnWon=(w_1stIn-w_1stWon)/w_1stIn,l_2ndReturnWon=((w_svpt-w_1stIn)-w_2ndWon)/(w_svpt-w_1stIn)
)]

#Modification Date et suppression des valeurs NaN sur les bp_saved
Tennis_table_work[,date:=anydate(tourney_date)][,.(date,tourney_date)]
Tennis_table_work[is.nan(w_bpSaved),':='(w_bpSaved=1)]
Tennis_table_work[is.nan(l_bpSaved),':='(l_bpSaved=1)]
```


Fonction d'historique
```{r}
###f_historique renvoi les statistiques moyennes d'un joueur en fonctions de différentes variables
### Variable obligatoire :
####Tennis_table_work = table d'historique des matchs, doit contenir les colonnes :  "tourney_id"     "tourney_name"   "surface"        "tourney_date"   "tourney_level"  "match_num"      "w_id"           "w_name"         "w_age"         "w_ht"           "w_rank"         "w_rank_points"  "w_hand"         "w_seed"         "w_ace"          "w_df"           "w_1stIn"        "w_1stWon"      "w_2ndWon"       "w_bpSaved"      "w_bpMean"       "w_bpConverted"  "w_svptWon"      "w_returnPtWon"  "w_1stReturnWon" "w_2ndReturnWon" "l_id"          "l_name"         "l_age"          "l_ht"           "l_rank"         "l_rank_points"  "l_hand"         "l_seed"         "l_ace"          "l_df"          "l_1stIn"        "l_1stWon"       "l_2ndWon"       "l_bpSaved"      "l_bpMean"       "l_bpConverted"  "l_svptWon"      "l_returnPtWon"  "l_1stReturnWon"  "l_2ndReturnWon"
####i_name = Nom du joueur
### Variables Optionelles : 
####i_date = Date à partir de laquelle on considère l'historique
####i_surface = Type de surface -> 'Hard'|'Clay'|'Grass'|'None'
####i_tournament = Nom du tournoi -> 'Barcelona'|Bournemouth'|'US Open'
####i_opponent = Nom de l'opposant -> 'Raphael Nadal'|'Roger Federer'|'Alexander Zverev'
####i_row = Nombre de matchs à prendre en compte
####i_duree = Durée en jours d'historique à prendre en compte
f_historique <- function(Tennis_table_work,i_name,i_date=NULL,i_surface=NULL,i_tournament=NULL,i_opponent=NULL,i_row=NULL,i_duree=NULL, i_round=NULL, i_matchnum=NULL) {
  historique=rbind(Tennis_table_work[w_name==i_name,.(tourney_date,tourney_name,surface,opponent=l_name,ace=w_ace,df=w_df,stIn=w_1stIn,stWon=w_1stWon,ndWon=w_2ndWon,bpSaved=w_bpSaved,bpMean=w_bpMean,bpConverted=w_bpConverted,svptWon=w_svptWon,returnPtWon=w_returnPtWon,stReturnWon=w_1stReturnWon,ndReturnWon=w_2ndReturnWon)][order(-tourney_date)],
  Tennis_table_work[l_name==i_name,.(tourney_date,tourney_name,surface,opponent=w_name,ace=l_ace,df=l_df,stIn=l_1stIn,stWon=l_1stWon,ndWon=l_2ndWon,bpSaved=l_bpSaved,bpMean=l_bpMean,bpConverted=l_bpConverted,svptWon=l_svptWon,returnPtWon=l_returnPtWon,stReturnWon=l_1stReturnWon,ndReturnWon=l_2ndReturnWon)])[order(-tourney_date)]
  
  if (!is.null(i_date)) {historique=historique[tourney_date<anydate(i_date)|(anydate(i_date)==tourney_date&round_num>i_round)]}
  #AJOUTER match_num<match_num ou round<i_round pour les tourney_date=i_date
  #OU i_date==tourney_date&round_num>i_round F=1 SF=2 QF=3 etc OU i_round=='RR' i_matchnum<match_num
  if ((!is.null(i_date))&(!is.null(i_duree))) {historique=historique[difftime(anydate(i_date),tourney_date)<=i_duree]}
  if (!is.null(i_surface)) {historique=historique[surface==i_surface]}
  if (!is.null(i_tournament)) {historique=historique[tourney_name==i_tournament]}
  if (!is.null(i_opponent)) {historique=historique[opponent==i_opponent]}
  if (!is.null(i_row)) {historique=historique[,head(.SD,i_row)]}
  
  Historique_Mean=historique[,.(ace,df,stIn,stWon,ndWon,bpSaved,bpMean,bpConverted,svptWon,returnPtWon,stReturnWon,ndReturnWon)][,lapply(.SD, function(x) mean(na.omit(x[is.finite(x)])))]
  return(Historique_Mean)
}

###TEST
Tennis_table_work[,max(tourney_date)]
i_name='Alexander Zverev';i_opponent='Rafael Nadal';i_date='20170101'
Tennis_table_work[(w_name==i_name&l_name==i_opponent)|(l_name==i_name&w_name==i_opponent)]
f_historique(Tennis_table_work,i_name)
f_historique(Tennis_table_work,i_name=i_name,i_opponent=i_opponent)
f_historique(Tennis_table_work,i_name=i_name,i_opponent=i_opponent,i_date=i_date)
f_historique(Tennis_table_work,i_name=i_name,i_opponent=i_opponent,i_row=1)
f_historique(Tennis_table_work,i_name=i_name,i_opponent=i_opponent,i_tournament = 'Australian Open')
```

Stats joueurs match
Attention : 557 match avec svgms=0 !!!
```{r}


```




Creation du nombre de jeu et du nombre de Set
comprendre gsub http://www.endmemo.com/program/R/gsub.php 
```{r}


Tennis_table[,.(score,base::sum(as.numeric(unlist(str_extract_all(gsub("\\(\\d\\)","",score), "[0-9]+"))))),by=c(colnames(Tennis_table))]

#### Calcul le nombre de jeux à partir du score
### Variable obligatoire :
####Tennis_table_work = table d'historique des matchs
####score = Nom de la variable de score
f_NombreDeJeu <- function(Tennis_table_work,score) {
  return(Tennis_table_work[,.(NbJeuJoue=sum(as.numeric(unlist(str_extract_all(gsub("\\(\\d\\)","",score), "[0-9]+"))))),by=c(colnames(Tennis_table_work))])
}
Tennis_table_work_test=f_NombreDeJeu(Tennis_table,"score")

#### Calcul le nombre de jeux précdemment joués (ou le temps)
### Variable obligatoire :
####Tennis_table_work = table d'historique des matchs
####i_name = Nom du joueur
####i_date = Date de calcul
####i_duree = Duree à prendre en compte
f_fatigue <- function(Tennis_table_work,i_name,i_date,i_duree) {
  historique=rbind(Tennis_table_work[winner_name==i_name],
  Tennis_table_work[loser_name==i_name])[anydate(i_date)>anydate(tourney_date)][difftime(anydate(i_date),anydate(tourney_date))<=i_duree]
  
  Historique_Sum=historique[,.(NbJeuJoue,minutes)][,lapply(.SD, function(x) sum(na.omit(x[is.finite(x)])))]
  
  return(Historique_Sum)
}
```
TESTS FATIGUES
```{r}
##################TESTS
i_name='Borna Coric';i_date='20180305';i_duree=365;

Tennis_table_NbJeux=f_NombreDeJeu(Tennis_table,"score")

f_fatigue(Tennis_table_NbJeux,i_name,i_date,100)[,NbJeuJoue]

start_time <- Sys.time()
Table_Fatigue=Tennis_table_NbJeux[,.(fatigue=(f_fatigue(Tennis_table_NbJeux,winner_name,tourney_date,3)[,NbJeuJoue]-f_fatigue(Tennis_table_NbJeux,loser_name,tourney_date,3)[,NbJeuJoue])),by=c(colnames(Tennis_table_NbJeux))]
end_time <- Sys.time()
time=end_time - start_time

Table_Fatigue[tourney_id=='2001-520']
nrow(Table_Fatigue[fatigue>0])/nrow(Table_Fatigue[fatigue!=0])
nrow(Table_Fatigue[fatigue<0])/nrow(Table_Fatigue[fatigue!=0])
Tennis_table[tourney_date>'20180301',.(tourney_id,match_num,fatigue=f_fatigue(Tennis_table[tourney_date>'20180301'],winner_name,tourney_date,100)[,scorenum])]
Tennis_table[tourney_date>'20180301',.(fatigue=f_fatigue(Tennis_table[tourney_date>'20180301'],winner_name,tourney_date,100)[,scorenum]),by=.(winner_name,tourney_date)]
Tennis_table[tourney_date>'20180301',.(tourney_id,match_num,fatigue=f_fatigue(Tennis_table[tourney_date>'20180301'],winner_name,tourney_date,100)[,scorenum]),by=.()]

for (i in 1:10) {
  name=Tennis_table[tourney_date>'20180301'][i,winner_name]
  date=Tennis_table[tourney_date>'20180301'][i,tourney_date]
  print(f_fatigue(Tennis_table,name,date,100)[,scorenum])
}
name
date
f_fatigue(Tennis_table,"Borna Coric","20180305",100)
Tennis_table[winner_name=="Borna Coric"]
```

Gros problème de dates des matchs absente
```{R}
Tennis_table[tourney_name=='Us Open'&tourney_date>='20180801'&winner_name=='Rafael Nadal']
Tennis_table[tourney_date>'20000101',length(gregexpr(" ",winner_name)[[1]]),by=winner_name][,.N,by=V1]
Tennis_table[winner_name=='Arnaud Di Pasquale']
install.packages("readxl")
library("readxl")

nrow(Tennis_table[tourney_date>'20030101'])

Tmp_Data_Date=rbind(data.table(read_excel("Data/Dates/2003.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2004.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2005.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2006.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2007.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2008.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2009.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2010.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2011.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2012.xls"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2013.xlsx"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2014.xlsx"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2015.xlsx"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2016.xlsx"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2017.xlsx"))[,.(Tournament,Date,Surface,Round,Winner,Loser)]
,data.table(read_excel("Data/Dates/2018.xlsx"))[,.(Tournament,Date,Surface,Round,Winner,Loser)])

Tennis_table[winner_name=='Arnaud Di Pasquale']

str_locate('Arnaud Di Pasquale', ' ')
paste(substr('Arnaud Di Pasquale',str_locate('Arnaud Di Pasquale', ' ')+1,nchar('Arnaud Di Pasquale')),paste(substr(substr('Arnaud Di Pasquale',0 ,str_locate('Arnaud Di Pasquale', ' ')-1),0,1),'.', sep=''),sep=' ')

Tennis_table[,Winner_NameSmall:=paste(substr(winner_name,str_locate(winner_name, ' ')+1,nchar(winner_name)),paste(substr(substr(winner_name,0 ,str_locate(winner_name, ' ')-1),0,1),'.', sep=''),sep=' ')]
Tennis_table[,Loser_NameSmall:=paste(substr(loser_name,str_locate(loser_name, ' ')+1,nchar(loser_name)),paste(substr(substr(loser_name,0 ,str_locate(loser_name, ' ')-1),0,1),'.', sep=''),sep=' ')]

merge(Tennis_table,Tmp_Data_Date,by.x=c("tourney_name","surface","Winner_NameSmall","Loser_NameSmall"),by.y=c("Tournament", "Surface", "Winner", "Loser"))
merge(Tennis_table,Tmp_Data_Date,by.x=c("tourney_name"),by.y=c("Tournament"))

Tmp_Data_Date[,Tournament,by=Tournament]
sqldf(
  "SELECT tourney_name, Tournament
  FROM
  (SELECT tourney_name FROM Tennis_table GROUP BY tourney_name) as a
  LEFT JOIN 
  (SELECT Tournament,min(Date) as DateMin FROM Tmp_Data_Date GROUP BY Tournament) as b ON a.tourney_name=b.Tournament
  
  "
)
sqldf(
  "SELECT tourney_name, Tournament
  FROM
  (SELECT Tournament FROM Tmp_Data_Date GROUP BY Tournament) as a
  LEFT JOIN 
  (SELECT tourney_name FROM Tennis_table GROUP BY tourney_name) as b ON b.tourney_name=a.Tournament
  "
)
```

Creation d'un flag abandon => on ne fait pas la distinction entre abandonn? pendant le match 
et abandonner avant le match, mode du flag ? valider
```{r}
Abandon<-gsub("[[:space:]]","",gsub("\\d+","",gsub("[[:punct:]]" ,"",Tennis_table$score)))
Abandon
Abandonv2<-gsub("[^A-Za-z]","",Tennis_table$score)

####Ajoute à Tennis_Table la colonne abandon (0 ou 1)
f_abandon <- function (Tennis_table,score) {
  return(Tennis_table[,abandon:=ifelse(gsub("[^A-Za-z]","",score)!="",1,0)])
}
f_abandon(Tennis_table,"score")

#### Renvoie si le joueur i_name est de retour d'abandon à la date i_date
f_retour_abandon <- function(Tennis_table, i_name, i_date) {
  return(Tennis_table[(winner_name==i_name|loser_name==i_name)][tourney_date<i_date][head(order(-tourney_date,-match_num),1),c(ifelse(abandon==1&loser_name==i_name,1,0))])
}

i_name='Rafael Nadal'; i_date='20180101'
Tennis_table[(winner_name==i_name|loser_name==i_name)][tourney_date<i_date][head(order(-tourney_date,-match_num),1)]
f_retour_abandon(Tennis_table,i_name,i_date)==1
```
```{R}
sqldf(
  "
  SELECT b.round, count(*)
FROM (
  SELECT tourney_name
        ,tourney_date
        ,max(match_num) max_match
  FROM Tennis_table
  WHERE tourney_date<'20180101'
  GROUP BY tourney_name
        ,tourney_date
) as a
LEFT JOIN Tennis_table as b ON a.tourney_name=b.tourney_name AND a.tourney_date=b.tourney_date AND a.max_match=b.match_num
  GROUP BY b.round"
)
sqldf(
  "
  SELECT *
FROM (
  SELECT tourney_name
        ,tourney_date
        ,max(match_num) max_match
  FROM Tennis_table
  WHERE tourney_date<'20180101'
  GROUP BY tourney_name
        ,tourney_date
) as a
LEFT JOIN Tennis_table as b ON a.tourney_name=b.tourney_name AND a.tourney_date=b.tourney_date AND a.max_match=b.match_num
WHERE b.round<>'F'"
)
Tennis_table[tourney_name=='Indian Wells Masters'&tourney_date=='19960311']
```

Reorganisation de la table pour que le le winner ait 50% de chance d'être joueur 1/ joueur 2 => avoid sur-apprentissage
```{r}
set.seed(123)
Coin<- round((runif(nrow(Tennis_table),0,1)),0)
head(Tennis_table)

# !!!!! essayer i in seq_along(Tennis_table) !!!!!

for (i in seq_along(Tennis_table)) {
if (Coin[i] == 1) {
Tennis_table[i,':='(player1_id=winner_id, player1_seed=winner_seed, player1_entry= winner_entry,player1_name=winner_name,player1_hand=winner_hand,player1_ht=winner_ht,player1_ioc=winner_ioc,
player1_age=winner_age,player1_rank=winner_rank,player1_rank_points=winner_rank_points,
player2_id=loser_id, player2_seed=loser_seed, player2_entry= loser_entry,player2_name=loser_name,player2_hand=loser_hand,player2_ht=loser_ht,player2_ioc=loser_ioc,
player2_age=loser_age,player2_rank=loser_rank,player2_rank_points=loser_rank_points),]
}
if (Coin[i]==0 ){
Tennis_table[i, ':='(player2_id=winner_id, player2_seed=winner_seed, player2_entry= winner_entry, player2_name=winner_name,player2_hand=winner_hand,player2_ht=winner_ht,player2_ioc=winner_ioc,
player2_age=winner_age,player2_rank=winner_rank,player2_rank_points=winner_rank_points,
player1_id=loser_id, player1_seed=loser_seed, player1_entry= loser_entry, player1_name=loser_name,player1_hand=loser_hand,player1_ht=loser_ht,player1_ioc=loser_ioc,
player1_age=loser_age,player1_rank=loser_rank,player1_rank_points=loser_rank_points),]
}
}

pb<-Tennis_table[is.na(player1_name)]
head(pb)
ok<-Tennis_table[!(is.na(player1_name))]
ok
```

Retraitement des dates
```{r}
mode(Tennis_table$tourney_date)
Tennis_table$tourney_date
Tennis_table[, tourney_date_char:=as.character(tourney_date)][,':='(annee=substr(tourney_date_char,1,4),
mois=substr(tourney_date_char,5,6),
jour=substr(tourney_date_char,7,nchar(tourney_date_char)))][,]
Tennis_table[,DateTourney:=as.Date(paste(jour,mois,annee,sep="/"),"%d/%m/%Y")]
```

n dernières confrontation, reflechir à comment prendre en compte le n compter le nombre de victoire 

```{r}
n=5
ratioPlayer1<-c(rep(0,nrow(Tennis_table)))
ratioPlayer2<-c(rep(0,nrow(Tennis_table)))
NbrVictPlayer1<-c(rep(0,nrow(Tennis_table)))
NbrVictPlayer2<-c(rep(0,nrow(Tennis_table)))
for (i in seq_along(Tennis_table)) {

date_i<-Tennis_table$DateTourney[i]
player1<-Tennis_table$player1_id[i]
player2<-Tennis_table$player2_id[i]

temp<-setorder(Tennis_table[(DateTourney<date) & 
((player1_id==player1 & player2_id ==player2) | (player1_id==player2 & player2_id ==player1))],-DateTourney)[1:n]

ratioPlayer1[i]<-mean(as.numeric(player1==temp$winner_id))
ratioPlayer2[i]<-mean(as.numeric(player2==temp$winner_id))
NbrVictPlayer1[i]<-sum(as.numeric(player1==temp$winner_id))
NbrVictPlayer2[i]<-sum(as.numeric(player2==temp$winner_id)) 
}
table(ratioPlayer1)
Tennis_table[,':='(ratioPlayer1=ratioPlayer1,ratioPlayer2=ratioPlayer2,NbrVictPlayer1=NbrVictPlayer1,NbrVictPlayer2=NbrVictPlayer2)]

```







#sqldf("SELECT df2.firstname, df2.lastname, df1.var1, df2.state FROM df1 INNER JOIN df2 ON df1.personid = df2.id WHERE df2.state = 'TX'")
